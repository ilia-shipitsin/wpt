name: Test
on:
  push
jobs:
  test1:
    name: windows-2022
    runs-on: windows-2022
    steps:
    
    - run: |
       choco install windows-performance-toolkit
       "C:\Program Files (x86)\Windows Kits\8.1\Windows Performance Toolkit\xperf.exe" -start -on LOADER+PROC_THREAD+DISK_IO+HARD_FAULTS+DPC+INTERRUPT+CSWITCH+PERF_COUNTER+FILE_IO_INIT+REGISTRY
      shell: cmd
    
    - run: |
        rustup --help
      shell: cmd
      
    - run: |
        "c:\Program Files (x86)\Windows Kits\8.1\Windows Performance Toolkit\xperf.exe" -d tmp.etl
      shell: cmd

    - name: Archive ETL
      uses: actions/upload-artifact@v3
      with:
        name: WPP
        path: tmp.etl
            
  test2:
    name: ilia-tmp-15
    runs-on: ilia-tmp-15
    steps:
    
      - run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module -Name Start-ProcessAsUser -Force
          
          Import-Module Start-ProcessAsUser
          
          $winStn = [Win32API.User32]::GetProcessWindowStation()
          if (![Win32API.User32]::GetUserObjectInformation($winStn,[Win32API.User32+UserObjectInformationIndex]::UOI_FLAGS).dwFlags)
          {
             throw "Window station is not visible; If you run this Cmdlet in the service context, you may need to set the value of HKLM:\System\CurrentControlSet\Control\Windows::NoInteractiveServices to 0."
          }
        shell: powershell
        
        
        
